---
title: "Accelerometer and GPS data wrangling"
author: "Daniel Fuller"
date: "08/10/2021"
output:
      html_document:
        keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lubridate)
library(ggmap)
library(stringr)
library(data.table)
library(scales)
library(signal)
library(magrittr)
library(furrr)
library(purrr)
library(activityCounts)
```

# Accelerometer Data Wrangling

These data are from Ethica Data, which is app manufacturer our INTERACT team has been working with for the past 7 years. 

```{r}
accel_data <- read.csv("accel_sample_data.csv")

glimpse(accel_data)

table(accel_data$user_id)
```

# Accel data processing

Tasks

1. Decide which method we are going to use for data processing
    * ActiGraph Activity Counts (AAC) - [https://cran.r-project.org/web/packages/activityCounts/index.html](https://cran.r-project.org/web/packages/activityCounts/index.html)
    * Euclidean Norm Minus One (ENMO) - [https://cran.r-project.org/web/packages/GGIR/index.html](https://cran.r-project.org/web/packages/GGIR/index.html)
    * Monitor Independent Movement Summary (MIMS) [https://cran.r-project.org/web/packages/MIMSunit/index.html](https://cran.r-project.org/web/packages/MIMSunit/index.html)
    
### Sorting out time

These data are different from most accelerometer data because the phone does not capture accelerometer data like a traditional research grade device. It optimizes for battery life and often does not have a consistent number of hertz per second. So unlike data were you will set the hertz to 30 or 100 this will be different. 

# ou will probably have to resample the data... but we are not going to do that today because don't have time. 

```{r}
accel_data$time_factor <- as.factor(accel_data$record_time)

accel_data <- accel_data %>%
  group_by(record_time) %>%
  mutate(
         milli = row_number(),
         n = n()
  )

summary(accel_data$milli)
```

# Dealing with time

```{r}
accel_data$day <- day(accel_data$record_time)  ## Create an hour variable
accel_data$hour <- hour(accel_data$record_time)  ## Create an hour variable
accel_data$minute <- minute(accel_data$record_time)  ## Create a minute variable
accel_data$second <- second(accel_data$record_time)  ## Create a second variable
``` 

# Calculating ENMO

```{r}
accel_data <- accel_data %>%
                mutate(
                  x_g = x_axis/9.80665,
                  y_g = y_axis/9.80665,
                  z_g = z_axis/9.80665,
                  enmo = x_g^2+y_g^2+z_g^2,
                  enmo_m1 = (x_g^2+y_g^2+z_g^2)-1
                )
```

```{r}
summary(accel_data$enmo_m1)

accel_data <- dplyr::filter(accel_data, enmo_m1 < 20)

summary(accel_data$enmo_m1)
```

```{r}
accel_sec <- accel_data %>%
  group_by(user_id, day, hour, minute, second) %>%
  summarise(
         time = first(record_time), 
         user_id = first(user_id),
         m_x_g = mean(x_g),
         m_y_g = mean(y_g),
         m_z_g = mean(z_g),
         enmo_m1 = mean(abs(enmo_m1)),
         enmo_m1_mg = enmo_m1*1000
        )

summary(accel_sec$enmo_m1_mg)

ggplot(accel_sec, aes(enmo_m1_mg)) +
        geom_histogram()
```

#### 5. Use the cut points from this [paper](https://doi.org/10.3389/fspor.2020.579278) and create a new variable called `activity`. 

| Activity | Cut Point (enmo_m1) | 
|----------|-----------|
| Sedentary | <= 255 |
| Moderate | > 255 to <= 588 | 
| Moderate | >= 588 to max |

*Note. Don't do this at home. Should make sure your sample frequency is correct for the method you are using.*

```{r}
accel_sec <- accel_sec %>%
	mutate(activity = case_when(
		enmo_m1_mg <= 255 ~ "1. Sedentary",
		enmo_m1_mg > 255 & enmo_m1_mg <= 588 ~ "2. Light",
		enmo_m1_mg > 588 ~ "3. Moderate",
		TRUE ~ "other"
	))

table(accel_sec$activity)
```

```{}
fig1 <- ggplot(accel_sec, aes(x = time, y = enmo_m1)) + 
          geom_point(alpha = 0.01, aes(colour = factor(activity))) + 
            xlab("Time") +
            ylab("ENMO") +
        facet_wrap(~ user_id)
plot(fig1)
```

# GPS Sample Data

```{r}
gps_data <- read_csv("gps_sample_data.csv")

glimpse(gps_data)
```

```{r}
gps_plot_1 <- ggplot(gps_data) + 
                  geom_point(aes(x = lon, y = lat)) +
                  facet_wrap(~ user_id)
plot(gps_plot_1)
```

```{r}
canada_basemap <- get_map(location = "St. John's, Newfoundland, Canada",
                     source = "google",
                     maptype = "roadmap", crop = FALSE,
                     zoom = 12)

maps_points <- ggmap(canada_basemap) + 
                  geom_point(aes(x = lon, y = lat), data = gps_data, alpha = 0.2) + 
                  facet_wrap(~ user_id)

plot(maps_points)
```

